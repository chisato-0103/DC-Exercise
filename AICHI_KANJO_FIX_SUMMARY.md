# æ„›çŸ¥ç’°çŠ¶ç·šçµ±åˆ ä¿®æ­£å®Œäº†ã‚µãƒãƒªãƒ¼

## ä¿®æ­£å®Œäº†æ—¥
2025-10-31

## å•é¡Œã®çµŒé

### åˆæœŸçŠ¶æ…‹ï¼ˆå‰ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼‰
- æ„›çŸ¥ç’°çŠ¶ç·šï¼ˆaichi_kanjoï¼‰ã®é§…ãƒ‡ãƒ¼ã‚¿ï¼š23é§…ãŒç™»éŒ² âœ…
- æ„›çŸ¥ç’°çŠ¶ç·šã®æ™‚åˆ»è¡¨ï¼š2,806ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒç™»éŒ² âœ…
- APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼šroutesé…åˆ—ãŒç©ºã§è¿”ã•ã‚Œã‚‹ âŒ
- è¡¨ç¤ºç”»é¢ï¼šã€Œãƒ«ãƒ¼ãƒˆã‚’è¡¨ç¤ºã—ãªããªã£ã¦ã¾ã™ã€ã¨ã„ã†å ±å‘Š

### åŸå› èª¿æŸ»

#### ç¬¬1æ®µéšï¼šé§…ã‚³ãƒ¼ãƒ‰æ¤œè¨¼
**å•é¡Œ**: `isValidStationCode()`ãŒæ„›çŸ¥ç’°çŠ¶ç·šã®é§…ã‚³ãƒ¼ãƒ‰ã‚’ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã—ã¦ã„ãªã„
**åŸå› **: é–¢æ•°ã®ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆã«æ„›çŸ¥ç’°çŠ¶ç·šã®23é§…ãŒå«ã¾ã‚Œã¦ã„ãªã‹ã£ãŸ
**è§£æ±º**: [includes/functions.php:164-202](./includes/functions.php#L164-L202) ã«å…¨23é§…ã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ 
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… ä¿®æ­£å®Œäº†ï¼ˆå‰ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼‰

#### ç¬¬2æ®µéšï¼šæ—¥ä»˜ç¨®åˆ¥ï¼ˆday_typeï¼‰ã®ä¸ä¸€è‡´
**å•é¡Œ**: APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒç©ºã® routes ã‚’è¿”ã—ç¶šã‘ã‚‹
**åŸå› ã®å¾¹åº•èª¿æŸ»**:
- ãƒ­ãƒ¼ã‚«ãƒ« MySQL: aichi_kanjo ãƒ¬ã‚³ãƒ¼ãƒ‰ã¯ 2,806 ä»¶å­˜åœ¨ âœ…
- stations ãƒ†ãƒ¼ãƒ–ãƒ«: 23é§…ã™ã¹ã¦å­˜åœ¨ âœ…
- getStationInfo(): okazakié§…ã®æƒ…å ±ã¯å–å¾—å¯èƒ½ âœ…
- **getNextRailTrains(): åˆ—è»Šãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚‰ãªã„ âŒ**

**æ ¹æœ¬åŸå› **:
```
getCurrentDayType() ãŒè¿”ã™å€¤: 'weekday_green' / 'holiday_red'  ï¼ˆLinimoç”¨ï¼‰
rail_timetable ã® day_type: 'weekday' / 'holiday'  ï¼ˆæ±ç”¨ï¼‰
                     â†“
æ¤œç´¢æ¡ä»¶ãŒãƒãƒƒãƒã—ãªã„ â†’ åˆ—è»ŠãŒè¦‹ã¤ã‹ã‚‰ãªã„ â†’ routes ãŒç©º
```

**ä¿®æ­£å†…å®¹**: [config/settings.php:150-167](./config/settings.php#L150-L167)

```php
// ä¿®æ­£å‰ï¼ˆLinimoç”¨ã®å¤ã„å€¤ï¼‰
function getCurrentDayType() {
    ...
    if ($dayOfWeek === 0 || $dayOfWeek === 6) {
        return 'holiday_red';
    }
    if (in_array($month, [2, 3, 8, 9])) {
        return 'holiday_red';
    }
    return 'weekday_green';
}

// ä¿®æ­£å¾Œï¼ˆrail_timetableç”¨ã®æ±ç”¨å€¤ï¼‰
function getCurrentDayType() {
    ...
    if ($dayOfWeek === 0 || $dayOfWeek === 6) {
        return 'holiday';  // â† ä¿®æ­£
    }
    if (in_array($month, [2, 3, 8, 9])) {
        return 'holiday';  // â† ä¿®æ­£
    }
    return 'weekday';  // â† ä¿®æ­£
}
```

**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… ä¿®æ­£å®Œäº†

## ãƒ†ã‚¹ãƒˆçµæœ

### ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒãƒ†ã‚¹ãƒˆ

**å®Ÿè¡Œç’°å¢ƒ**: Mac MAMP (MySQL 8.0, PHP 7.4+)

**ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ 1**: å¤§å­¦ â†’ å²¡å´é§…
```bash
curl "http://localhost:8888/DC-Exercise/api/get_next_connection.php?direction=to_station&line_code=aichi_kanjo&destination=okazaki&time=09:00:00"
```

**ä¿®æ­£å‰ã®çµæœ**:
```json
{
    "routes": []  // ç©º
}
```

**ä¿®æ­£å¾Œã®çµæœ**: âœ…
```json
{
    "success": true,
    "routes": [
        {
            "shuttle_departure": "09:40",
            "shuttle_arrival": "09:45",
            "rail_departure": "09:56",
            "destination_arrival": "10:08",
            "transfer_time": 11,
            "total_time": 68,
            "waiting_time": 40,
            "destination_name": "å²¡å´"
        },
        {
            "shuttle_departure": "10:05",
            ...
        },
        {
            "shuttle_departure": "10:50",
            ...
        }
    ]
}
```

**çµæœ**: âœ… 3ä»¶ã®ãƒ«ãƒ¼ãƒˆå€™è£œãŒæ­£å¸¸ã«è¿”ã•ã‚Œã‚‹

### ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ç¢ºèª

| é …ç›® | å€¤ | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ |
|------|-----|-----------|
| aichi_kanjoé§…æ•° | 23 | âœ… |
| rail_timetable (aichi_kanjo) | 2,806 | âœ… |
| rail_timetable (linimo) | 4,982 | âœ… |
| isValidStationCode() | 23é§…å¯¾å¿œ | âœ… |
| getCurrentDayType() | æ±ç”¨å€¤å¯¾å¿œ | âœ… |

## ã‚³ãƒ¼ãƒ‰å¤‰æ›´ã‚µãƒãƒªãƒ¼

### ã‚³ãƒŸãƒƒãƒˆ 1: `8490cab`
```
æ„›çŸ¥ç’°çŠ¶ç·šï¼šday_typeåˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ã‚’ä¿®æ­£ï¼ˆweekday_green/holiday_red â†’ weekday/holidayï¼‰

ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«: config/settings.php
ä¿®æ­£ç®‡æ‰€: getCurrentDayType() é–¢æ•°ï¼ˆ150-167è¡Œï¼‰
ä¿®æ­£å†…å®¹: LinimoDayTypeã‹ã‚‰æ±ç”¨DayTypeã¸ã®å¤‰æ›´
```

### ã‚³ãƒŸãƒƒãƒˆ 2: `745041d`
```
æ„›çŸ¥ç’°çŠ¶ç·šï¼šãƒ†ã‚¹ãƒˆçµæœãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 

è¿½åŠ ãƒ•ã‚¡ã‚¤ãƒ«: AICHI_KANJO_TEST_RESULTS.md
å†…å®¹: ãƒ†ã‚¹ãƒˆæ‰‹é †ã¨çµæœ
```

## EC2 ã¸ã®åæ˜ æ–¹æ³•

### å¿…é ˆæ‰‹é †

```bash
# EC2ã«SSHæ¥ç¶š
ssh ubuntu@[EC2_IP]

# ã‚³ãƒ¼ãƒ‰ã‚’æ›´æ–°
cd /var/www/html
git pull origin main

# Web ã‚µãƒ¼ãƒãƒ¼ãŒPHPã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆã¯ãƒªã‚»ãƒƒãƒˆ
sudo systemctl restart apache2  # (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)
```

### å‹•ä½œç¢ºèª

#### 1. API ãƒ¬ãƒ™ãƒ«ã®ãƒ†ã‚¹ãƒˆ

```bash
# EC2ã‚µãƒ¼ãƒãƒ¼ã§å®Ÿè¡Œ
curl "http://localhost/api/get_next_connection.php?direction=to_station&line_code=aichi_kanjo&destination=okazaki&time=09:00:00"

# ãƒ­ãƒ¼ã‚«ãƒ« PC ã‹ã‚‰å®Ÿè¡Œï¼ˆEC2_IP ã‚’ç½®ãæ›ãˆï¼‰
curl "http://[EC2_IP]/api/get_next_connection.php?direction=to_station&line_code=aichi_kanjo&destination=okazaki&time=09:00:00"
```

**ç¢ºèªãƒã‚¤ãƒ³ãƒˆ**: `routes` é…åˆ—ã«è¤‡æ•°ã®å€™è£œãŒå«ã¾ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª

#### 2. ãƒ–ãƒ©ã‚¦ã‚¶ãƒ†ã‚¹ãƒˆ

```
http://[EC2_IP]
```

1. ã€Œãƒ«ãƒ¼ãƒˆé¸æŠã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã€Œæ„›çŸ¥ç’°çŠ¶ç·šã€ã‚’é¸æŠ
2. é§…é¸æŠã§ä»»æ„ã®é§…ï¼ˆä¾‹ï¼šå²¡å´ï¼‰ã‚’é¸æŠ
3. ãƒ«ãƒ¼ãƒˆå€™è£œãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
4. å®Ÿéš›ã®ä¹—ã‚Šç¶™ãæ™‚é–“ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚‚ã— EC2 ã§ã‚‚ routes ãŒç©ºã®å ´åˆ

1. **git pull ã®ç¢ºèª**
   ```bash
   git log --oneline -3
   # 8490cab ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
   ```

2. **PHP ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ã‚¯ãƒªã‚¢**
   ```bash
   # opcacheãŒæœ‰åŠ¹ãªå ´åˆ
   php -r 'opcache_reset();'
   ```

3. **æ—¥ä»˜ç¨®åˆ¥ã®ç¢ºèª**
   ```bash
   php -r "
   require_once '/var/www/html/config/settings.php';
   echo 'Day Type: ' . getCurrentDayType() . PHP_EOL;
   "
   ```

   **æœŸå¾…å€¤**: `Day Type: weekday` ï¼ˆåœŸæ—¥ä»¥å¤–ã®å–¶æ¥­æ—¥ï¼‰

4. **åˆ—è»Šãƒ‡ãƒ¼ã‚¿ã®ç¢ºèª**
   ```bash
   mysql -u root -p'rootpass123' ait_transport -e \
   "SELECT COUNT(*) FROM rail_timetable WHERE line_code='aichi_kanjo' AND day_type='weekday' LIMIT 1;"
   ```

   **æœŸå¾…å€¤**: 0ã‚ˆã‚Šå¤§ãã„æ•°å€¤

## ä¿®æ­£å†…å®¹ã®æŠ€è¡“çš„è©³ç´°

### ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆã®å•é¡Œç‚¹
Linimoï¼ˆãƒªãƒ‹ãƒ¢ï¼‰è·¯ç·šå‘ã‘ã«è¨­è¨ˆã•ã‚ŒãŸå¤ã„ day_typeï¼ˆ`weekday_green`/`holiday_red`ï¼‰ãŒã€æ–°ã—ã„ã‚ªãƒ—ã‚·ãƒ§ãƒ³ B æ±ç”¨ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆ`rail_timetable`ï¼‰ã§ä½¿ç”¨ã•ã‚Œã‚‹å€¤ï¼ˆ`weekday`/`holiday`ï¼‰ã¨ä¹–é›¢ã—ã¦ã„ã¾ã—ãŸã€‚

### è§£æ±ºæ–¹æ³•
ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¨ API ã®å„æ‰€ã§ç•°ãªã‚‹ day_type ã‚’ä½¿ç”¨ã™ã‚‹ä»£ã‚ã‚Šã«ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼ˆ`config/settings.php`ï¼‰ã®`getCurrentDayType()`é–¢æ•°ã‚’æ±ç”¨å€¤ã«çµ±ä¸€ã—ã¾ã—ãŸã€‚

### å½±éŸ¿ç¯„å›²
- âœ… æ„›çŸ¥ç’°çŠ¶ç·šï¼ˆaichi_kanjoï¼‰: æ­£å¸¸ã«å‹•ä½œ
- âœ… ãƒªãƒ‹ãƒ¢ï¼ˆlinimoï¼‰: ç¶™ç¶šã—ã¦æ­£å¸¸ã«å‹•ä½œï¼ˆãƒªãƒ‹ãƒ¢ç”¨ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å‡¦ç†ã§ weekday_green/holiday_red ã«å¤‰æ›ï¼‰
- âœ… ã‚·ãƒ£ãƒˆãƒ«ãƒã‚¹ï¼ˆshuttleï¼‰: ãƒ€ã‚¤ãƒ¤ç¨®åˆ¥ï¼ˆA/B/Cï¼‰ã§åˆ¶å¾¡ï¼ˆday_type éä¾å­˜ï¼‰

## å®Œäº†é …ç›®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [x] å•é¡Œã®æ ¹æœ¬åŸå› ã‚’ç‰¹å®š
- [x] ã‚³ãƒ¼ãƒ‰ä¿®æ­£ã‚’å®Ÿè£…
- [x] ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
- [x] ä¿®æ­£å†…å®¹ã‚’GitHub ã«ãƒ—ãƒƒã‚·ãƒ¥
- [x] ãƒ†ã‚¹ãƒˆçµæœãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆ
- [x] EC2 ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †ã‚’æ–‡æ›¸åŒ–
- [ ] EC2 ã§å‹•ä½œç¢ºèªï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå®Ÿè¡Œï¼‰

## è£œè¶³

ã“ã®ä¿®æ­£ã«ã‚ˆã‚Šã€æ„›çŸ¥ç’°çŠ¶ç·šçµ±åˆã¯å®Œå…¨ã«æ©Ÿèƒ½ã™ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚EC2 ã¸ã®åæ˜ å¾Œã¯ã€ä»¥ä¸‹ã®æ©Ÿèƒ½ãŒåˆ©ç”¨å¯èƒ½ã«ãªã‚Šã¾ã™ï¼š

- ğŸšŒ å¤§å­¦ â†’ æ„›çŸ¥ç’°çŠ¶ç·šå„é§…ã¸ã®ä¹—ã‚Šç¶™ãæ¤œç´¢
- ğŸšƒ æ„›çŸ¥ç’°çŠ¶ç·šå„é§… â†’ å¤§å­¦ã¸ã®ä¹—ã‚Šç¶™ãæ¤œç´¢
- ğŸ“ 23é§…ã™ã¹ã¦ã§ã®é‹è¡Œæ™‚é–“è¨ˆç®—
- ğŸ”„ ä¹—ã‚Šæ›ãˆæ™‚é–“ã‚‚å«ã‚ãŸç·æ‰€è¦æ™‚é–“ã®è¡¨ç¤º
