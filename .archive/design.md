# 愛知工業大学 交通情報システム 設計書

## 1. システム概要

### 1.1 目的
愛知工業大学のシャトルバスとリニモの時刻表・乗り継ぎ情報を一目でわかりやすく表示し、利用者の待ち時間を最小化するためのWebアプリケーション。

### 1.2 想定ユーザー
- 愛知工業大学を利用する全ての人（学生、教職員、来訪者など）

### 1.3 対象範囲（Phase 1）
- シャトルバス：八草駅 ⇔ 大学
- 鉄道：リニモ（八草駅〜藤が丘駅間の各駅）

---

## 2. 機能要件

### 2.1 主要機能

#### 2.1.1 トップ画面（次の便表示）
- 現在時刻から「次に乗れる便」を自動表示
- デフォルト目的地：藤が丘駅
- 表示内容：
  - 推奨される乗り継ぎパターン（複数候補）
  - シャトルバス発車時刻
  - リニモ接続便の発車時刻
  - 到着予定時刻
  - 乗り換え時間

#### 2.1.2 目的地選択機能
- **大学 → リニモ各駅**
  - 八草駅、陶磁資料館南駅、愛・地球博記念公園駅、公園西駅、芸大通駅、長久手古戦場駅、杁ヶ池公園駅、はなみずき通駅、藤が丘駅

- **リニモ各駅 → 大学**
  - 上記の逆方向

#### 2.1.3 乗り継ぎ最適化機能
- 待ち時間が最小となるシャトルバスとリニモの組み合わせを計算
- 乗り換え時間の考慮（デフォルト：10分）
- 複数の候補を表示（最適な上位数件）

#### 2.1.4 時刻表表示
- シャトルバスの時刻表（A/B/Cダイヤ対応）
- リニモの時刻表（各駅）
- ダイヤ切り替え機能

#### 2.1.5 運行情報表示
- 運休情報
- 遅延情報
- お知らせ
- ※Phase 1では手動更新、将来的に自動化予定

### 2.2 非機能要件

#### 2.2.1 レスポンシブデザイン
- スマートフォン、タブレット、PC対応
- モバイルファーストのUI設計

#### 2.2.2 パフォーマンス
- ページ読み込み時間：3秒以内
- リアルタイム計算による快適な操作感

#### 2.2.3 保守性
- 時刻表データの変更が容易
- 乗り換え時間などのパラメータを設定ファイルで管理
- コードの可読性・保守性を重視

#### 2.2.4 アクセシビリティ
- 誰でもアクセス可能（認証不要）
- シンプルで直感的なUI

---

## 3. システム構成

### 3.1 技術スタック

| 項目 | 技術 |
|------|------|
| フロントエンド | HTML5, CSS3, JavaScript (Vanilla) |
| バックエンド | PHP 7.4以上 |
| データベース | MySQL 5.7以上 |
| サーバー環境 | MAMP (Mac, Apache, MySQL, PHP) |
| バージョン管理 | Git |

### 3.2 アーキテクチャ

```
[ブラウザ]
    ↓
[Apache Webサーバー]
    ↓
[PHPアプリケーション]
    ↓
[MySQL データベース]
```

### 3.3 ディレクトリ構成

```
/project-root/
├── index.php              # トップページ（次の便表示）
├── timetable.php          # 時刻表表示
├── search.php             # 乗り継ぎ検索結果
├── api/
│   ├── get_next_connection.php    # 次の便取得API
│   ├── search_connection.php      # 乗り継ぎ検索API
│   └── get_timetable.php          # 時刻表取得API
├── config/
│   ├── database.php       # DB接続設定
│   └── settings.php       # システム設定（乗り換え時間など）
├── includes/
│   ├── functions.php      # 共通関数
│   └── db_functions.php   # DB操作関数
├── assets/
│   ├── css/
│   │   └── style.css      # スタイルシート
│   └── js/
│       └── app.js         # JavaScriptファイル
└── sql/
    └── setup.sql          # DB初期化スクリプト
```

---

## 4. データベース設計

### 4.1 テーブル構成

#### 4.1.1 shuttle_bus_timetable（シャトルバス時刻表）

| カラム名 | 型 | 制約 | 説明 |
|---------|-----|------|------|
| id | INT | PRIMARY KEY, AUTO_INCREMENT | ID |
| dia_type | ENUM('A', 'B', 'C') | NOT NULL | ダイヤ種別 |
| direction | ENUM('to_university', 'to_yagusa') | NOT NULL | 方向 |
| departure_time | TIME | NOT NULL | 発車時刻 |
| arrival_time | TIME | NOT NULL | 到着時刻 |
| is_active | BOOLEAN | DEFAULT TRUE | 運行中フラグ |
| remarks | VARCHAR(255) | NULL | 備考 |

#### 4.1.2 linimo_timetable（リニモ時刻表）

| カラム名 | 型 | 制約 | 説明 |
|---------|-----|------|------|
| id | INT | PRIMARY KEY, AUTO_INCREMENT | ID |
| station_code | VARCHAR(10) | NOT NULL | 駅コード |
| station_name | VARCHAR(50) | NOT NULL | 駅名 |
| direction | ENUM('to_fujigaoka', 'to_yakusa') | NOT NULL | 方向 |
| departure_time | TIME | NOT NULL | 発車時刻 |
| day_type | ENUM('weekday_green', 'holiday_red') | NOT NULL | 曜日種別（緑=平日4-7,10-1月、赤=土休日+8,9,2,3月） |
| is_active | BOOLEAN | DEFAULT TRUE | 運行中フラグ |

**注:** day_typeの詳細
- `weekday_green`: 4月〜7月、10月〜1月の平日（緑時刻）
- `holiday_red`: 土休日と8月、9月、2月、3月の平日（赤時刻）

#### 4.1.3 stations（駅マスタ）

| カラム名 | 型 | 制約 | 説明 |
|---------|-----|------|------|
| id | INT | PRIMARY KEY, AUTO_INCREMENT | ID |
| station_code | VARCHAR(10) | UNIQUE, NOT NULL | 駅コード |
| station_name | VARCHAR(50) | NOT NULL | 駅名 |
| station_name_en | VARCHAR(100) | NULL | 駅名（英語） |
| order_index | INT | NOT NULL | 並び順（八草=1, 藤が丘=13） |
| travel_time_from_yagusa | INT | NOT NULL | 八草駅からの所要時間（分） |

#### 4.1.4 notices（運行情報・お知らせ）

| カラム名 | 型 | 制約 | 説明 |
|---------|-----|------|------|
| id | INT | PRIMARY KEY, AUTO_INCREMENT | ID |
| notice_type | ENUM('delay', 'suspension', 'info') | NOT NULL | 通知種別 |
| target | ENUM('shuttle', 'linimo', 'all') | NOT NULL | 対象 |
| title | VARCHAR(100) | NOT NULL | タイトル |
| content | TEXT | NOT NULL | 内容 |
| start_date | DATETIME | NOT NULL | 表示開始日時 |
| end_date | DATETIME | NULL | 表示終了日時 |
| is_active | BOOLEAN | DEFAULT TRUE | 表示フラグ |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 作成日時 |

#### 4.1.5 system_settings（システム設定）

| カラム名 | 型 | 制約 | 説明 |
|---------|-----|------|------|
| id | INT | PRIMARY KEY, AUTO_INCREMENT | ID |
| setting_key | VARCHAR(50) | UNIQUE, NOT NULL | 設定キー |
| setting_value | VARCHAR(255) | NOT NULL | 設定値 |
| description | TEXT | NULL | 説明 |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新日時 |

**初期設定値：**
- `transfer_time_minutes`: 10（乗り換え時間）
- `current_dia_type`: A（現在のダイヤ種別）
- `default_destination`: fujigaoka（デフォルト目的地）

---

## 5. 画面設計

### 5.1 トップ画面（index.php）

#### レイアウト（仮）
```
┌─────────────────────────────────┐
│  愛工大交通情報システム          │
├─────────────────────────────────┤
│  [運行情報・お知らせ]            │
├─────────────────────────────────┤
│  目的地: [藤が丘 ▼]  [検索]      │
├─────────────────────────────────┤
│  次の便（現在時刻: 09:15）       │
│                                 │
│  ┌──────────────────────┐      │
│  │ 推奨ルート①              │      │
│  │ 大学発 09:20              │      │
│  │  ↓ シャトルバス（5分）    │      │
│  │ 八草駅着 09:25            │      │
│  │  ↓ 乗り換え（10分）       │      │
│  │ 八草駅発 09:35            │      │
│  │  ↓ リニモ（25分）         │      │
│  │ 藤が丘着 10:00            │      │
│  │                          │      │
│  │ 総所要時間: 40分          │      │
│  └──────────────────────┘      │
│                                 │
│  ┌──────────────────────┐      │
│  │ 推奨ルート②              │      │
│  │ ...                      │      │
│  └──────────────────────┘      │
├─────────────────────────────────┤
│  [時刻表を見る] [詳細検索]       │
└─────────────────────────────────┘
```

### 5.2 時刻表画面（timetable.php）

#### レイアウト（仮）
```
┌─────────────────────────────────┐
│  時刻表                          │
├─────────────────────────────────┤
│  [シャトルバス] [リニモ]         │
├─────────────────────────────────┤
│  ダイヤ: [A ▼]                  │
│  方向: [大学→八草 ▼]            │
├─────────────────────────────────┤
│  06:00  06:30  07:00  ...       │
│  07:15  07:45  08:15  ...       │
│  ...                            │
└─────────────────────────────────┘
```

---

## 6. API設計

### 6.1 次の便取得API

**エンドポイント:** `GET /api/get_next_connection.php`

**パラメータ:**
- `destination`: 目的地駅コード（デフォルト: fujigaoka）
- `time`: 基準時刻（省略時は現在時刻）
- `limit`: 取得件数（デフォルト: 3）

**レスポンス例:**
```json
{
  "success": true,
  "current_time": "09:15:00",
  "destination": "藤が丘",
  "connections": [
    {
      "shuttle_departure": "09:20:00",
      "shuttle_arrival": "09:25:00",
      "linimo_departure": "09:35:00",
      "linimo_arrival": "10:00:00",
      "transfer_time": 10,
      "total_time": 40,
      "waiting_time": 5
    }
  ]
}
```

### 6.2 乗り継ぎ検索API

**エンドポイント:** `GET /api/search_connection.php`

**パラメータ:**
- `from`: 出発地（"university" or 駅コード）
- `to`: 目的地（"university" or 駅コード）
- `time`: 出発時刻
- `limit`: 取得件数

### 6.3 時刻表取得API

**エンドポイント:** `GET /api/get_timetable.php`

**パラメータ:**
- `type`: shuttle or linimo
- `dia_type`: A, B, C（シャトルバスの場合）
- `direction`: 方向
- `station`: 駅コード（リニモの場合）

---

## 7. 乗り継ぎ計算ロジック

### 7.1 アルゴリズム概要

1. 現在時刻（または指定時刻）を取得
2. 出発地に応じて処理分岐：

#### パターンA: 大学 → リニモ各駅
```
1. 現在時刻以降の「大学発シャトルバス」を取得
2. 各シャトルバスの八草駅到着時刻を計算
3. 到着時刻 + 乗り換え時間（10分）以降のリニモ発車便を検索
4. 目的地までの所要時間を計算
5. 待ち時間と総所要時間でソート
6. 上位N件を返す
```

#### パターンB: リニモ各駅 → 大学
```
1. 出発駅から八草駅までのリニモ便を取得
2. 八草駅到着時刻を計算
3. 到着時刻 + 乗り換え時間以降の「八草発シャトルバス」を検索
4. 総所要時間を計算
5. ソートして上位N件を返す
```

### 7.2 計算式

```
総所要時間 = (シャトルバス所要時間) + (乗り換え時間) + (リニモ所要時間)
待ち時間 = (次の便の出発時刻) - (現在時刻)
```

---

## 8. 設定管理

### 8.1 変更が想定される設定項目

以下の項目は `config/settings.php` または `system_settings` テーブルで管理し、容易に変更可能にする：

- **乗り換え時間** (transfer_time_minutes)
- **現在のダイヤ種別** (current_dia_type)
- **デフォルト目的地** (default_destination)
- **表示件数** (result_limit)
- **シャトルバス所要時間** (shuttle_travel_time)

### 8.2 設定ファイル例

`config/settings.php`:
```php
<?php
// システム設定
define('TRANSFER_TIME_MINUTES', 10);  // 乗り換え時間
define('SHUTTLE_TRAVEL_TIME', 5);     // シャトルバス所要時間（分）
define('DEFAULT_DESTINATION', 'fujigaoka');
define('RESULT_LIMIT', 3);            // 表示する乗り継ぎ候補数
define('CURRENT_DIA_TYPE', 'A');      // 現在のダイヤ

// リニモ各駅の八草駅からの所要時間（分）
$linimo_travel_times = [
    'yagusa' => 0,
    'togei_shiryokan_minami' => 2,
    'geidai_dori' => 4,
    'koen_nishi' => 6,
    'ai_chikyuhaku_kinen_koen' => 8,
    'nagakute_kojoba' => 10,
    'irigaike_koen' => 12,
    'hanamizuki_dori' => 14,
    'nagoya_gakuin_daigaku' => 16,
    'nagakute_shiyakusho' => 18,
    'geijutsu_daigaku' => 20,
    'nagakute_furoen' => 22,
    'fujigaoka' => 25
];
?>
```

---

## 9. 実際の時刻表データ（PDFより）

### 9.1 シャトルバス運行日程

**ダイヤ種別と適用期間:**
- **Aダイヤ**: 授業期間の平日（4月〜7月、10月〜1月の平日）
- **Bダイヤ**: 土曜日・一部の平日
- **Cダイヤ**: 学校休業期間（8月、9月、2月、3月の平日）
- **休**: 日曜・祝日は原則運休（大学行事等により変更あり）

**運行会社:**
- 青字ダイヤ: ジェイアール東海バス株式会社（車椅子対応車両）
- 赤字ダイヤ: つばめ自動車株式会社

### 9.2 シャトルバス時刻表（実データ）

#### **Aダイヤ（授業期間平日）**

##### 八草駅 → 愛知工業大学
| 時 | 分 |
|----|-----|
| 8  | 00, 05, 10, 15, 20, 25, 30, 35, 40, 45, 50, 55 |
| 9  | 00, 05, 10, 15, 20, 25, 30, 35, 40, 50, 55 |
| 10 | 00, 05, 10, 15, 20, 25, 30, 35, 45, 55 |
| 11 | 05, 15, 25, 35, 45, 55 |
| 12 | 05, 15, 25, 35, 45, 55 |
| 13 | 05, 20, 35, 50 |
| 14 | 05, 15, 25, 35, 45, 55 |
| 15 | 05, 15, 30, 45 |
| 16 | 00, 15, 30, 45 |
| 17 | 00, 10, 25, 40 |
| 18 | 00, 15, 45 |
| 19 | 00, 15, 30, 45 |
| 20 | 00, 30 |
| 21 | 00 |

##### 愛知工業大学 → 八草駅
| 時 | 分 |
|----|-----|
| 8  | 20, 50 |
| 9  | 20, 50 |
| 10 | 20, 50 |
| 11 | 00, 10, 20, 30, 40, 50 |
| 12 | 00, 10, 20, 30, 40, 50 |
| 13 | 00, 15, 30, 45 |
| 14 | 00, 10, 20, 30, 40, 45, 50, 55 |
| 15 | 00, 10, 20, 30, 40, 50 |
| 16 | 00, 05, 10, 15, 25, 30, 35, 40, 45, 50, 55 |
| 17 | 00, 10, 15, 20, 25, 30, 35, 40, 45, 55 |
| 18 | 00, 10, 20, 30, 40, 50 |
| 19 | 00, 15, 30, 45 |
| 20 | 00, 15, 30, 45 |
| 21 | 00, 15, 30, 45 |

#### **Bダイヤ（土曜日）**

##### 八草駅 → 愛知工業大学
| 時 | 分 |
|----|-----|
| 8  | 00, 10, 20, 35, 45 |
| 9  | 00, 05, 25, 35, 50 |
| 10 | 00, 10, 30, 55 |
| 11 | 00, 25, 50 |
| 12 | 25 |
| 13 | 35 |
| 14 | 05, 35 |
| 15 | 05, 35 |
| 16 | 05, 45 |
| 17 | 10, 45 |
| 18 | 05, 35 |
| 19 | 35 |
| 20 | 25 |
| 21 | 05 |

##### 愛知工業大学 → 八草駅
| 時 | 分 |
|----|-----|
| 8  | 50 |
| 9  | 40 |
| 10 | 05, 50 |
| 11 | 15, 40 |
| 12 | 10 |
| 13 | 20, 50 |
| 14 | 20, 50 |
| 15 | 20, 50 |
| 16 | 20 |
| 17 | 00, 30, 55 |
| 18 | 20, 50 |
| 19 | 20, 50 |
| 20 | 40 |
| 21 | 30 |

#### **Cダイヤ（学校休業期間）**

##### 八草駅 → 愛知工業大学
| 時 | 分 |
|----|-----|
| 8  | 10, 35 |
| 9  | 00, 25, 50 |
| 10 | 10, 55 |
| 11 | 25, 50 |
| 12 | 25 |
| 13 | 35 |
| 14 | 05, 35 |
| 15 | 05, 35 |
| 16 | 05, 45 |
| 17 | 10, 45 |
| 18 | 05, 35 |
| 19 | 35 |
| 20 | 25 |
| 21 | 05 |

##### 愛知工業大学 → 八草駅
| 時 | 分 |
|----|-----|
| 8  | 50 |
| 9  | 40 |
| 10 | 05, 50 |
| 11 | 15, 40 |
| 12 | 10 |
| 13 | 20, 50 |
| 14 | 20, 50 |
| 15 | 20, 50 |
| 16 | 20 |
| 17 | 00, 30, 55 |
| 18 | 20, 50 |
| 19 | 20, 50 |
| 20 | 40 |
| 21 | 30 |

**注意事項:**
- シャトルバスは無料です
- 所要時間: 約5分
- 天候、道路交通障害等により遅延する可能性あり

### 9.3 リニモ時刻表（実データ）

#### **運行パターン**
- **緑時刻**: 4月〜7月、10月〜1月の平日に運転
- **赤時刻**: 土休日と8月、9月、2月、3月の平日（学校休業期間）に運転

#### **駅間所要時間**
各駅間: 約2分（一部3分）
- 八草 → 陶磁資料館南: 2分
- 陶磁資料館南 → 愛・地球博記念公園: 2分
- 愛・地球博記念公園 → 公園西: 2分
- 公園西 → 芸大通: 2分
- 芸大通 → 長久手古戦場: 2分
- 長久手古戦場 → 杁ヶ池公園: 2分
- 杁ヶ池公園 → はなみずき通: 2分
- はなみずき通 → 藤が丘: 3分

**八草駅から各駅までの所要時間:**
- 八草 → 藤が丘: 約17分

#### **八草駅発（藤が丘方面）主要時間帯の例**

| 時 | 平日（緑）の分 |
|----|---------------|
| 5  | 48 |
| 6  | 03, 18, 32, 42, 51 |
| 7  | 00, 08, 16, 24, 31, 38, 46, 54 |
| 8  | 02, 10, 18, 26, 33, 40, 48, 56 |
| 9〜20 | 概ね8分間隔 |
| 21 | 02, 10, 18, 26, 34, 42, 50, 59 |
| 22 | 08, 18, 28, 39, 50 |
| 23 | 01, 12, 23, 34, 46 |

**※ 詳細な全時刻はPDFデータを元にDBに格納**

### 9.4 駅マスタ初期データ

リニモ全駅（八草〜藤が丘間）

| 駅コード | 駅名 | 駅名（英語） | 並び順 | 八草駅からの所要時間 |
|---------|------|-------------|--------|---------------------|
| yakusa | 八草 | Yakusa | 1 | 0分 |
| tojishiryokan_minami | 陶磁資料館南 | Tojishiryokan Minami | 2 | 2分 |
| ai_chikyuhaku_kinen_koen | 愛・地球博記念公園 | Ai･Chikyuhaku Kinen Koen | 3 | 4分 |
| koen_nishi | 公園西 | Koen Nishi | 4 | 6分 |
| geidai_dori | 芸大通 | Geidai-dori | 5 | 8分 |
| nagakute_kosenjo | 長久手古戦場 | Nagakute Kosenjo | 6 | 10分 |
| irigaike_koen | 杁ヶ池公園 | Irigaike Koen | 7 | 12分 |
| hanamizuki_dori | はなみずき通 | Hanamizuki-dori | 8 | 14分 |
| fujigaoka | 藤が丘 | Fujigaoka | 9 | 17分 |

**注:**
- 駅間所要時間はPDFデータより、各駅2分、最終区間のみ3分
- リニモには他にも駅（長久手市役所、名古屋学院大学など）がありますが、Phase 1では八草〜藤が丘間の主要駅のみ実装

---

## 10. 開発フェーズ

### Phase 1（初期リリース）
- ✓ シャトルバス（八草⇔大学）
- ✓ リニモ（八草〜藤が丘）
- ✓ 基本的な乗り継ぎ検索
- ✓ 次の便表示
- ✓ 時刻表表示
- ✓ 運行情報の手動更新

### Phase 2（機能拡張）
- 愛知環状線の追加
- 管理画面の実装

---

## 11. 保守・運用

### 11.1 定期的なメンテナンス項目

- **時刻表の更新**
  - ダイヤ改正時にDBを更新
  - `sql/update_timetable.sql` を用意し、簡単に更新可能に

- **運行情報の管理**
  - `notices` テーブルに手動で情報を追加
  - 表示期間を設定して自動的に非表示化

- **設定値の調整**
  - `config/settings.php` または管理画面から変更

### 11.2 バックアップ

- データベースの定期バックアップ（毎日）
- 設定ファイルのバージョン管理

---

## 12. 今後の拡張性

### 12.1 将来追加予定の機能

1. **愛知環状線の統合**
   - 新テーブル: `aikan_timetable`
   - 駅マスタへの追加

2. **管理画面**
   - お知らせ管理
   - システム設定管理

---

## 13. セキュリティ考慮事項

- SQLインジェクション対策（プリペアドステートメント使用）
- XSS対策（出力時のエスケープ処理）
- CSRF対策（将来の管理画面実装時）
- 入力値のバリデーション

---

## 14. パフォーマンス最適化

- インデックスの適切な設定
- クエリの最適化
- 静的ファイルのキャッシュ
- CDN活用（将来的に）

---

## 付録A: 用語集

| 用語 | 説明 |
|------|------|
| Aダイヤ | 授業期間平日の時刻表 |
| Bダイヤ | 土曜日の時刻表 |
| Cダイヤ | 長期休暇期間の時刻表 |
| 乗り換え時間 | バスと電車の乗り継ぎに必要な時間（デフォルト10分） |
| 待ち時間 | 現在時刻から次の便までの時間 |
| 総所要時間 | 出発から到着までの合計時間 |

---

## 付録B: 参考資料

- リニモ公式サイト: https://www.linimo.jp/
- 愛知工業大学公式サイト: https://www.ait.ac.jp/

---

**作成日:** 2025-10-15
**バージョン:** 1.0
**最終更新:** 2025-10-15
